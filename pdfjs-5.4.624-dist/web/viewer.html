<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate">
    <title>Digital Theological Library ‚Äî Reader</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìñ</text></svg>">

    <!-- PDF.js Core Library (rendering only, no viewer UI) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600;8..60,700&family=DM+Sans:wght@400;500;600;700&display=swap');

        :root {
            --dtl-blue: #154889;
            --dtl-blue-hover: #123F79;
            --dtl-blue-light: #1a5ba6;
            --dtl-red: #AF161C;
            --dtl-red-hover: #961318;
            --text-primary: #1f2937;
            --text-muted: #6b7280;
            --text-light: #9ca3af;
            --bg-main: #e8e8e8;
            --bg-toolbar: #1a1a2e;
            --bg-toolbar-hover: rgba(255,255,255,0.1);
            --page-shadow: 0 2px 16px rgba(0,0,0,0.15);
            --toolbar-height: 52px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
            -webkit-user-select: none;
            user-select: none;
        }

        /* ===== TOOLBAR ===== */
        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--toolbar-height);
            background: var(--bg-toolbar);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 10000;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #chapterName {
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            font-weight: 500;
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toolbar-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            font-size: 16px;
        }

        .toolbar-btn:hover {
            background: var(--bg-toolbar-hover);
            border-color: rgba(255,255,255,0.3);
        }

        .toolbar-btn:active { transform: scale(0.95); }

        .toolbar-btn:disabled {
            opacity: 0.3;
            cursor: default;
        }

        .toolbar-btn:disabled:hover {
            background: transparent;
            border-color: rgba(255,255,255,0.15);
        }

        .page-info {
            color: rgba(255,255,255,0.85);
            font-size: 13px;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
            min-width: 80px;
            text-align: center;
        }

        .zoom-display {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            font-weight: 500;
            min-width: 45px;
            text-align: center;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: rgba(255,255,255,0.12);
            margin: 0 4px;
        }

        #dtlBrand {
            color: rgba(255,255,255,0.5);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* ===== PAGE CONTAINER ===== */
        #pageContainer {
            position: fixed;
            top: var(--toolbar-height);
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            overflow-x: auto;
            padding: 24px 0;
            scroll-behavior: auto;
        }

        .page-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
        }

        .page-slot {
            background: white;
            box-shadow: var(--page-shadow);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-slot canvas { display: block; }

        /* Loading spinner */
        .page-loading {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: white;
        }

        .page-loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e5e7eb;
            border-top-color: var(--dtl-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .page-loading-text {
            color: var(--text-light);
            font-size: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Page error state */
        .page-error {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: white;
            color: var(--text-muted);
            font-size: 13px;
        }

        .page-error-icon { font-size: 32px; }

        .page-error-retry {
            margin-top: 4px;
            padding: 6px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
        }

        .page-error-retry:hover { background: #f9fafb; }

        /* ===== OVERLAYS ===== */
        .overlay {
            position: fixed;
            inset: 0;
            z-index: 2147483647;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }

        .overlay-card {
            background: white;
            max-width: 460px;
            width: 100%;
            border-radius: 16px;
            padding: 38px 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .overlay-icon { font-size: 52px; margin-bottom: 14px; }

        .overlay-title {
            font-family: 'Source Serif 4', Georgia, serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .overlay-message {
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 18px;
            font-size: 14px;
        }

        .overlay-btn {
            display: block;
            width: 100%;
            padding: 14px 18px;
            border: 0;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: opacity 0.15s ease;
            text-decoration: none;
            text-align: center;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .overlay-btn:hover { opacity: 0.9; }
        .btn-blue { background: var(--dtl-blue); }
        .btn-red { background: var(--dtl-red); }

        .overlay-hint {
            color: var(--text-light);
            font-size: 12px;
            line-height: 1.5;
            margin-top: 4px;
        }

        .catalog-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 6px;
        }

        .catalog-link {
            display: block;
            padding: 14px 18px;
            border-radius: 10px;
            color: white;
            text-decoration: none;
            font-weight: 700;
            text-align: center;
        }

        /* ===== END OF CHAPTER CARD ===== */
        .end-card-wrapper {
            display: flex;
            justify-content: center;
            margin: 24px 0 48px 0;
        }

        .end-card {
            background: white;
            border-radius: 16px;
            padding: 36px 32px;
            text-align: center;
            max-width: 480px;
            width: 100%;
            box-shadow: var(--page-shadow);
        }

        .end-card-icon { font-size: 40px; margin-bottom: 12px; }

        .end-card-title {
            font-family: 'Source Serif 4', Georgia, serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .end-card-message {
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .end-card-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .end-card-links-label {
            color: var(--text-light);
            font-size: 13px;
            margin-bottom: 4px;
        }

        /* ===== PRINT BLOCKING ===== */
        @media print {
            html, body { display: none !important; }
        }

        /* ===== MOBILE ===== */
        @media (max-width: 640px) {
            .toolbar-center { position: static; transform: none; }
            #chapterName { display: none; }
            #dtlBrand { display: none; }
            .page-info { font-size: 12px; min-width: 60px; }
            #pageContainer { padding: 12px 0; }
            .toolbar-divider.hide-mobile { display: none; }
        }
    </style>
</head>

<body>
    <!-- ===== TOOLBAR ===== -->
    <div id="toolbar">
        <div class="toolbar-section">
            <span id="dtlBrand">DTL Reader</span>
        </div>

        <div class="toolbar-center">
            <button class="toolbar-btn" id="btnPrevPage" title="Previous page" disabled>
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <span class="page-info" id="pageInfo">‚Äî / ‚Äî</span>
            <button class="toolbar-btn" id="btnNextPage" title="Next page" disabled>
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn" id="btnZoomOut" title="Zoom out">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 8H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <span class="zoom-display" id="zoomDisplay">100%</span>
            <button class="toolbar-btn" id="btnZoomIn" title="Zoom in">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 4V12M4 8H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <button class="toolbar-btn" id="btnFitWidth" title="Fit to width" style="font-size: 13px; font-weight: 700;">W</button>
        </div>

        <div class="toolbar-section">
            <!-- Right side intentionally minimal -->
        </div>
    </div>

    <!-- ===== PAGE CONTAINER ===== -->
    <div id="pageContainer"></div>

    <!-- ==========================================================
         DTL STREAMING PDF VIEWER
         Security, rendering, and navigation logic
         ========================================================== -->
    <script>
    (function() {
        'use strict';

        // =============================================================
        // CONFIGURATION
        // =============================================================
        var WORKER_URL = 'https://dtl-pdf-stream.reference-dfe.workers.dev';
        var PREFETCH_AHEAD = 3;
        var PREFETCH_BEHIND = 1;
        var OBSERVER_MARGIN = '600px';

        // =============================================================
        // DTL PALETTE
        // =============================================================
        var DTL_BLUE = '#154889';
        var DTL_BLUE_HOVER = '#123F79';
        var DTL_RED = '#AF161C';
        var MUTED_COLOR = '#6b7280';

        // =============================================================
        // FRIENDLY ERROR PAGE
        // =============================================================
        function showErrorPage(icon, title, message) {
            document.documentElement.innerHTML = '\
                <head>\
                    <title>' + title + ' | Digital Theological Library</title>\
                    <meta name="viewport" content="width=device-width, initial-scale=1">\
                    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">\
                    <style>\
                        * { box-sizing: border-box; margin: 0; padding: 0; }\
                        body { display: flex; align-items: center; justify-content: center; min-height: 100vh; font-family: DM Sans, -apple-system, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); padding: 20px; }\
                        .card { background: white; padding: 48px 40px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; max-width: 420px; width: 100%; }\
                        .icon { font-size: 56px; margin-bottom: 20px; }\
                        h1 { margin: 0 0 12px 0; color: #1f2937; font-size: 24px; font-weight: 700; }\
                        .msg { color: #6b7280; margin: 0 0 28px 0; line-height: 1.6; }\
                        .links { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }\
                        .btn { display: block; padding: 14px 24px; color: white; text-decoration: none; border-radius: 8px; font-weight: 700; text-align: center; }\
                        .help { font-size: 13px; color: #9ca3af; }\
                    </style>\
                </head>\
                <body>\
                    <div class="card">\
                        <div class="icon">' + icon + '</div>\
                        <h1>' + title + '</h1>\
                        <p class="msg">' + message + '</p>\
                        <div class="links">\
                            <a href="https://libguides.thedtl.org/home" class="btn" style="background:#AF161C;">üìñ DTL Catalog</a>\
                            <a href="https://dtl2.libguides.com/home" class="btn" style="background:#154889;">üìö DTL2 Catalog</a>\
                        </div>\
                        <p class="help">Need help? Contact your librarian for assistance.</p>\
                    </div>\
                </body>';
            window.stop();
        }

        // =============================================================
        // TOKEN HELPERS
        // =============================================================
        function decodeToken(token) {
            if (!token) return null;
            try {
                var parts = token.split('.');
                if (parts.length < 2) return null;
                var base64 = parts[0].replace(/-/g, '+').replace(/_/g, '/');
                while (base64.length % 4) base64 += '=';
                var bytes = new Uint8Array(atob(base64).split('').map(function(c) { return c.charCodeAt(0); }));
                return JSON.parse(new TextDecoder().decode(bytes));
            } catch (e) { return null; }
        }

        // =============================================================
        // SECURITY CHECKS
        // =============================================================
        var ALLOWED_HOSTS = ['thedtl.org', 'thedtl.github.io', 'oclc.org', 'libapps.com', 'libguides.com', 'springshare.com', 'localhost', '127.0.0.1'];
        var isLocalDev = ['localhost', '127.0.0.1'].indexOf(location.hostname) !== -1;

        var referrer = document.referrer || '';
        if (!referrer && window.location.ancestorOrigins && window.location.ancestorOrigins.length > 0) {
            referrer = window.location.ancestorOrigins[window.location.ancestorOrigins.length - 1];
        }

        var isFirefoxBrowser = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;

        if (!referrer && !isLocalDev) {
            showErrorPage('üö´', 'New Tab/Window Not Allowed', 'For copyright protection, this resource cannot be opened in a new tab or window. Please click the link directly from the chapter list.');
            throw new Error('Access Denied: No Referrer');
        }

        var historyThreshold = isFirefoxBrowser ? 2 : 1;
        if (window.history.length <= historyThreshold && !isLocalDev) {
            showErrorPage('üö´', 'New Tab/Window Not Allowed', 'For copyright protection, this resource cannot be opened in a new tab or window. Please click the link directly from the chapter list.');
            throw new Error('Access Denied: New tab/window');
        }

        var isAllowedReferrer = isLocalDev || ALLOWED_HOSTS.some(function(host) {
            try { var refHost = new URL(referrer).hostname; return refHost === host || refHost.endsWith('.' + host); } catch (e) { return false; }
        });

        if (!isAllowedReferrer) {
            showErrorPage('üîó', 'Invalid Link Source', 'This resource must be accessed through the library website.');
            throw new Error('Access Denied: Invalid Referrer');
        }

        // =============================================================
        // PARSE TOKEN
        // =============================================================
        var urlParams = new URLSearchParams(window.location.search);
        var token = urlParams.get('token');

        if (!token) {
            showErrorPage('üîë', 'Missing Access Token', 'No access token was provided. Please return to the catalog and click the chapter link to access this resource.');
            throw new Error('No token provided');
        }

        var payload = decodeToken(token);

        if (!payload || !payload.s || !payload.e) {
            showErrorPage('üîë', 'Invalid Access Token', 'The access token is invalid or corrupted. Please return to the catalog and try again.');
            throw new Error('Invalid token');
        }

        // =============================================================
        // CHAPTER CONFIG
        // =============================================================
        var CONFIG = {
            token: token,
            start: payload.s,
            end: payload.e,
            chapterName: payload.c || '',
            allowDownload: payload.d === 1,
            totalPages: payload.e - payload.s + 1
        };

        console.log('[DTL] Config:', CONFIG);

        // =============================================================
        // KEYBOARD / INPUT BLOCKING
        // =============================================================
        if (!CONFIG.allowDownload) {
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && ['s', 'p', 'o', 'u'].indexOf(e.key.toLowerCase()) !== -1) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true);
        }

        document.addEventListener('contextmenu', function(e) { e.preventDefault(); }, true);
        document.addEventListener('auxclick', function(e) { if (e.button === 1) { e.preventDefault(); e.stopPropagation(); } }, true);
        document.addEventListener('click', function(e) { if (e.ctrlKey || e.metaKey || e.shiftKey) { e.preventDefault(); e.stopPropagation(); } }, true);
        document.addEventListener('dragstart', function(e) { e.preventDefault(); }, true);

        // =============================================================
        // BACK BUTTON TRAP
        // =============================================================
        var BUFFER_STATES = 200;
        var trapArmedThisSession = false;
        var SESSION_KEY = 'dtlStreamTrapArmed';
        try { sessionStorage.removeItem(SESSION_KEY); } catch (e) {}

        function isArmed() { return trapArmedThisSession; }

        function enableBeforeUnload() {
            window.addEventListener('beforeunload', function(e) {
                if (!isArmed()) return;
                e.preventDefault();
                e.returnValue = '';
                return '';
            });
        }

        function showSessionEndedOverlay() {
            if (document.getElementById('dtl-session-ended')) return;

            var overlay = document.createElement('div');
            overlay.id = 'dtl-session-ended';
            overlay.className = 'overlay';
            overlay.innerHTML =
                '<div class="overlay-card">' +
                    '<div class="overlay-icon">üîí</div>' +
                    '<div class="overlay-title">Session Ended</div>' +
                    '<div class="overlay-message">Your viewing session has ended. For copyright protection, you cannot return to the previous page.</div>' +
                    '<button class="overlay-btn btn-blue" id="dtl-session-return">üìñ Return to Chapter</button>' +
                    '<div class="catalog-links">' +
                        '<a href="https://libguides.thedtl.org/home" class="catalog-link" style="background:#AF161C;">üìñ DTL Catalog</a>' +
                        '<a href="https://dtl2.libguides.com/home" class="catalog-link" style="background:#154889;">üìö DTL2 Catalog</a>' +
                    '</div>' +
                    '<div class="overlay-hint" style="margin-top:14px;">Need help? Contact your librarian for assistance.</div>' +
                '</div>';

            document.body.appendChild(overlay);

            document.getElementById('dtl-session-return').addEventListener('click', function() {
                overlay.remove();
            });
        }

        function armTrapWithGesture() {
            try {
                var baseUrl = location.href.split('#')[0];
                history.replaceState({ dtlTrap: true, i: 0 }, '', baseUrl + '#dtl0');
                for (var i = 1; i <= BUFFER_STATES; i++) {
                    history.pushState({ dtlTrap: true, i: i }, '', baseUrl + '#dtl' + i);
                }
                trapArmedThisSession = true;
                sessionStorage.setItem(SESSION_KEY, '1');
                enableBeforeUnload();
            } catch (e) {
                trapArmedThisSession = true;
                enableBeforeUnload();
            }
        }

        window.addEventListener('popstate', function() {
            if (!isArmed()) return;
            showSessionEndedOverlay();
            if (isFirefoxBrowser) {
                setTimeout(function() { try { history.go(BUFFER_STATES); } catch (e) {} }, 50);
            } else {
                try { history.go(BUFFER_STATES); } catch (e) {}
            }
        });

        window.addEventListener('pageshow', function(event) {
            if (event && event.persisted) {
                try { if (sessionStorage.getItem(SESSION_KEY) === '1') showSessionEndedOverlay(); } catch (e) {}
            }
        });

        // =============================================================
        // PDF.js SETUP
        // =============================================================
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // =============================================================
        // STATE
        // =============================================================
        var RENDER_SCALE = 1.5;       // base rendering quality
        var displayScale = 1.0;       // user zoom level
        var baseWidth = null;         // natural width of first page at RENDER_SCALE
        var pageSlots = [];           // page-slot DOM elements
        var pageCache = {};           // pageNumber -> { bytes, rendered, width, height }
        var pageFetching = {};        // pageNumber -> true
        var currentVisiblePage = CONFIG.start;
        var serverTotalPages = null;
        var viewerInitialized = false;

        // DOM references
        var containerEl = document.getElementById('pageContainer');
        var pageInfoEl = document.getElementById('pageInfo');
        var zoomDisplayEl = document.getElementById('zoomDisplay');
        var btnPrev = document.getElementById('btnPrevPage');
        var btnNext = document.getElementById('btnNextPage');
        var btnZoomIn = document.getElementById('btnZoomIn');
        var btnZoomOut = document.getElementById('btnZoomOut');
        var btnFitWidth = document.getElementById('btnFitWidth');

        // =============================================================
        // FETCH SINGLE PAGE FROM WORKER
        // =============================================================
        function fetchPage(pageNum) {
            if (pageCache[pageNum]) return Promise.resolve(pageCache[pageNum]);
            if (pageFetching[pageNum]) {
                // Return a promise that waits for the existing fetch
                return new Promise(function(resolve, reject) {
                    var check = setInterval(function() {
                        if (pageCache[pageNum]) { clearInterval(check); resolve(pageCache[pageNum]); }
                        if (!pageFetching[pageNum] && !pageCache[pageNum]) { clearInterval(check); reject(new Error('Fetch failed')); }
                    }, 100);
                    setTimeout(function() { clearInterval(check); reject(new Error('Timeout')); }, 30000);
                });
            }

            pageFetching[pageNum] = true;

            var url = WORKER_URL + '/page?token=' + encodeURIComponent(CONFIG.token) + '&page=' + pageNum;

            return fetch(url)
                .then(function(response) {
                    if (!response.ok) throw new Error('HTTP ' + response.status);

                    // Read total pages from headers (first response sets this)
                    var tp = parseInt(response.headers.get('X-DTL-Total-Pages'));
                    if (tp && !serverTotalPages) {
                        serverTotalPages = tp;
                        CONFIG.end = Math.min(CONFIG.end, tp);
                        CONFIG.totalPages = CONFIG.end - CONFIG.start + 1;
                        console.log('[DTL] Server total pages:', tp, '| Effective range:', CONFIG.start, '-', CONFIG.end);
                    }

                    return response.arrayBuffer();
                })
                .then(function(buffer) {
                    pageCache[pageNum] = { bytes: new Uint8Array(buffer), rendered: false, width: 0, height: 0 };
                    pageFetching[pageNum] = false;
                    return pageCache[pageNum];
                })
                .catch(function(err) {
                    console.error('[DTL] Fetch page ' + pageNum + ' failed:', err);
                    pageFetching[pageNum] = false;
                    throw err;
                });
        }

        // =============================================================
        // RENDER SINGLE PAGE INTO ITS SLOT
        // =============================================================
        function renderPage(pageNum) {
            var cached = pageCache[pageNum];
            if (!cached) return Promise.resolve();

            var slotIndex = pageNum - CONFIG.start;
            if (slotIndex < 0 || slotIndex >= pageSlots.length) return Promise.resolve();
            var slot = pageSlots[slotIndex];
            if (!slot) return Promise.resolve();

            // Skip if already rendered at current zoom
            if (cached.rendered && cached.renderedZoom === displayScale) return Promise.resolve();

            return pdfjsLib.getDocument({ data: cached.bytes.slice() }).promise
                .then(function(pdf) {
                    return pdf.getPage(1);
                })
                .then(function(page) {
                    var scale = RENDER_SCALE * displayScale;
                    var viewport = page.getViewport({ scale: scale });

                    // Store natural dimensions (at base render scale)
                    if (!cached.width) {
                        var natVp = page.getViewport({ scale: RENDER_SCALE });
                        cached.width = natVp.width;
                        cached.height = natVp.height;
                        if (!baseWidth) baseWidth = natVp.width;
                    }

                    // Get or create canvas
                    var canvas = slot.querySelector('canvas');
                    if (!canvas) {
                        canvas = document.createElement('canvas');
                        var loading = slot.querySelector('.page-loading');
                        if (loading) loading.remove();
                        var error = slot.querySelector('.page-error');
                        if (error) error.remove();
                        slot.appendChild(canvas);
                    }

                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    canvas.style.width = viewport.width + 'px';
                    canvas.style.height = viewport.height + 'px';
                    slot.style.width = viewport.width + 'px';
                    slot.style.height = viewport.height + 'px';

                    var ctx = canvas.getContext('2d');
                    return page.render({ canvasContext: ctx, viewport: viewport }).promise;
                })
                .then(function() {
                    cached.rendered = true;
                    cached.renderedZoom = displayScale;
                })
                .catch(function(err) {
                    console.error('[DTL] Render page ' + pageNum + ' error:', err);
                    showPageError(pageNum);
                });
        }

        // =============================================================
        // PAGE ERROR DISPLAY
        // =============================================================
        function showPageError(pageNum) {
            var slotIndex = pageNum - CONFIG.start;
            if (slotIndex < 0 || slotIndex >= pageSlots.length) return;
            var slot = pageSlots[slotIndex];
            if (!slot) return;

            var loading = slot.querySelector('.page-loading');
            if (loading) loading.remove();
            if (slot.querySelector('.page-error')) return;

            var errorDiv = document.createElement('div');
            errorDiv.className = 'page-error';
            errorDiv.innerHTML =
                '<div class="page-error-icon">‚ö†Ô∏è</div>' +
                '<div>Failed to load page</div>' +
                '<button class="page-error-retry">Retry</button>';
            slot.appendChild(errorDiv);

            errorDiv.querySelector('.page-error-retry').addEventListener('click', function() {
                errorDiv.remove();
                var loadDiv = document.createElement('div');
                loadDiv.className = 'page-loading';
                loadDiv.innerHTML = '<div class="page-loading-spinner"></div><div class="page-loading-text">Loading page...</div>';
                slot.appendChild(loadDiv);
                delete pageCache[pageNum];
                delete pageFetching[pageNum];
                fetchAndRenderPage(pageNum);
            });
        }

        // =============================================================
        // FETCH + RENDER
        // =============================================================
        function fetchAndRenderPage(pageNum) {
            if (pageNum < CONFIG.start || pageNum > CONFIG.end) return Promise.resolve();
            if (pageCache[pageNum] && pageCache[pageNum].rendered && pageCache[pageNum].renderedZoom === displayScale) return Promise.resolve();

            return fetchPage(pageNum)
                .then(function() { return renderPage(pageNum); })
                .catch(function() { showPageError(pageNum); });
        }

        // =============================================================
        // CREATE PAGE SLOTS + END CARD
        // =============================================================
        function createPageSlots() {
            containerEl.innerHTML = '';
            pageSlots = [];

            for (var i = CONFIG.start; i <= CONFIG.end; i++) {
                var wrapper = document.createElement('div');
                wrapper.className = 'page-wrapper';
                wrapper.dataset.page = String(i);

                var slot = document.createElement('div');
                slot.className = 'page-slot';
                slot.style.width = '612px';
                slot.style.height = '792px';

                var loading = document.createElement('div');
                loading.className = 'page-loading';
                loading.innerHTML = '<div class="page-loading-spinner"></div><div class="page-loading-text">Loading page ' + (i - CONFIG.start + 1) + '...</div>';
                slot.appendChild(loading);

                wrapper.appendChild(slot);
                containerEl.appendChild(wrapper);
                pageSlots.push(slot);
            }

            // End-of-chapter card
            var endWrapper = document.createElement('div');
            endWrapper.className = 'end-card-wrapper';

            endWrapper.innerHTML =
                '<div class="end-card">' +
                    '<div class="end-card-icon">üìñ</div>' +
                    '<div class="end-card-title">End of Chapter</div>' +
                    '<div class="end-card-message">You\'ve reached the end of this section.</div>' +
                    '<div class="end-card-links">' +
                        '<div class="end-card-links-label">Looking for more? Browse our catalogs:</div>' +
                        '<a href="https://libguides.thedtl.org/home" class="catalog-link" style="background:#AF161C;">üìñ DTL Catalog</a>' +
                        '<a href="https://dtl2.libguides.com/home" class="catalog-link" style="background:#154889;">üìö DTL2 Catalog</a>' +
                    '</div>' +
                '</div>';

            containerEl.appendChild(endWrapper);
        }

        // =============================================================
        // INTERSECTION OBSERVER (LAZY LOADING)
        // =============================================================
        var observer = null;

        function setupObserver() {
            if (observer) observer.disconnect();

            observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (!entry.isIntersecting) return;
                    var pageNum = parseInt(entry.target.dataset.page);
                    if (isNaN(pageNum)) return;

                    fetchAndRenderPage(pageNum);
                    for (var a = 1; a <= PREFETCH_AHEAD; a++) fetchAndRenderPage(pageNum + a);
                    for (var b = 1; b <= PREFETCH_BEHIND; b++) fetchAndRenderPage(pageNum - b);
                });
            }, {
                root: containerEl,
                rootMargin: OBSERVER_MARGIN
            });

            var wrappers = containerEl.querySelectorAll('.page-wrapper');
            for (var i = 0; i < wrappers.length; i++) {
                observer.observe(wrappers[i]);
            }
        }

        // =============================================================
        // SCROLL TRACKING
        // =============================================================
        function updateCurrentPage() {
            var containerRect = containerEl.getBoundingClientRect();
            var containerCenter = containerRect.top + containerRect.height / 2;
            var closestPage = CONFIG.start;
            var closestDist = Infinity;

            for (var i = 0; i < pageSlots.length; i++) {
                var rect = pageSlots[i].getBoundingClientRect();
                var center = rect.top + rect.height / 2;
                var dist = Math.abs(center - containerCenter);
                if (dist < closestDist) {
                    closestDist = dist;
                    closestPage = CONFIG.start + i;
                }
            }

            if (closestPage !== currentVisiblePage) {
                currentVisiblePage = closestPage;
                updateToolbar();
            }
        }

        var scrollRaf = null;
        containerEl.addEventListener('scroll', function() {
            if (scrollRaf) cancelAnimationFrame(scrollRaf);
            scrollRaf = requestAnimationFrame(updateCurrentPage);
        });

        // =============================================================
        // TOOLBAR
        // =============================================================
        function updateToolbar() {
            var relPage = currentVisiblePage - CONFIG.start + 1;
            pageInfoEl.textContent = relPage + ' / ' + CONFIG.totalPages;
            zoomDisplayEl.textContent = Math.round(displayScale * 100) + '%';
            btnPrev.disabled = (currentVisiblePage <= CONFIG.start);
            btnNext.disabled = (currentVisiblePage >= CONFIG.end);
        }

        // =============================================================
        // NAVIGATION
        // =============================================================
        function goToPage(pageNum) {
            if (pageNum < CONFIG.start || pageNum > CONFIG.end) return;
            var idx = pageNum - CONFIG.start;
            var wrappers = containerEl.querySelectorAll('.page-wrapper');
            if (wrappers[idx]) {
                wrappers[idx].scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        btnPrev.addEventListener('click', function() { goToPage(currentVisiblePage - 1); });
        btnNext.addEventListener('click', function() { goToPage(currentVisiblePage + 1); });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft' || e.key === 'PageUp') { e.preventDefault(); goToPage(currentVisiblePage - 1); }
            else if (e.key === 'ArrowRight' || e.key === 'PageDown') { e.preventDefault(); goToPage(currentVisiblePage + 1); }
            else if (e.key === 'Home') { e.preventDefault(); goToPage(CONFIG.start); }
            else if (e.key === 'End') { e.preventDefault(); goToPage(CONFIG.end); }
        });

        // =============================================================
        // ZOOM
        // =============================================================
        var ZOOM_STEPS = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 2.5, 3.0];

        function reRenderAllVisible() {
            var keys = Object.keys(pageCache);
            for (var i = 0; i < keys.length; i++) {
                var pn = parseInt(keys[i]);
                if (pageCache[pn] && pageCache[pn].bytes) {
                    pageCache[pn].rendered = false;
                    renderPage(pn);
                }
            }
            updateToolbar();
        }

        function zoomTo(newScale) {
            displayScale = Math.max(0.5, Math.min(3.0, newScale));
            reRenderAllVisible();
        }

        btnZoomIn.addEventListener('click', function() {
            for (var i = 0; i < ZOOM_STEPS.length; i++) {
                if (ZOOM_STEPS[i] > displayScale) { zoomTo(ZOOM_STEPS[i]); return; }
            }
        });

        btnZoomOut.addEventListener('click', function() {
            for (var i = ZOOM_STEPS.length - 1; i >= 0; i--) {
                if (ZOOM_STEPS[i] < displayScale) { zoomTo(ZOOM_STEPS[i]); return; }
            }
        });

        btnFitWidth.addEventListener('click', function() {
            if (!baseWidth) return;
            var containerWidth = containerEl.clientWidth - 48;
            var fitScale = containerWidth / baseWidth;
            fitScale = Math.round(fitScale * 20) / 20;
            fitScale = Math.max(0.5, Math.min(3.0, fitScale));
            zoomTo(fitScale);
        });

        // =============================================================
        // GESTURE GATE
        // =============================================================
        function showGestureGate() {
            var gate = document.createElement('div');
            gate.id = 'dtl-gesture-gate';
            gate.className = 'overlay';
            gate.style.opacity = '0';
            gate.style.transition = 'opacity 0.2s ease';

            gate.innerHTML =
                '<div class="overlay-card" id="dtl-gate-card" style="transform:scale(0.95);transition:transform 0.2s ease;">' +
                    '<div class="overlay-icon">üìñ</div>' +
                    '<div class="overlay-title">Start Reading</div>' +
                    '<div class="overlay-message">Click below to begin your secure viewing session.</div>' +
                    '<button class="overlay-btn btn-blue" id="dtl-start-reading">Begin Session</button>' +
                    '<div class="overlay-hint">Using the browser back button will end your session.</div>' +
                    (isFirefoxBrowser ? '<div class="overlay-hint" style="font-style:italic;margin-top:4px;">Firefox users: The back button may appear disabled for copyright protection.</div>' : '') +
                '</div>';

            document.body.appendChild(gate);

            requestAnimationFrame(function() {
                gate.style.opacity = '1';
                var card = document.getElementById('dtl-gate-card');
                if (card) card.style.transform = 'scale(1)';
            });

            document.getElementById('dtl-start-reading').addEventListener('click', function() {
                armTrapWithGesture();
                gate.style.opacity = '0';
                var card = document.getElementById('dtl-gate-card');
                if (card) card.style.transform = 'scale(0.95)';
                setTimeout(function() { gate.remove(); initViewer(); }, 200);
            }, { once: true });
        }

        // =============================================================
        // INITIALIZE VIEWER
        // =============================================================
        function initViewer() {
            if (viewerInitialized) return;
            viewerInitialized = true;

            createPageSlots();
            updateToolbar();
            setupObserver();

            // Fetch first page to get server metadata, then auto-fit
            fetchAndRenderPage(CONFIG.start).then(function() {
                // Server may have adjusted CONFIG.end
                var currentSlots = pageSlots.length;
                var expectedSlots = CONFIG.end - CONFIG.start + 1;
                if (expectedSlots !== currentSlots) {
                    createPageSlots();
                    setupObserver();
                }
                updateToolbar();

                // Auto fit-to-width
                if (baseWidth) {
                    var w = containerEl.clientWidth - 48;
                    var fit = Math.round((w / baseWidth) * 20) / 20;
                    fit = Math.max(0.5, Math.min(3.0, fit));
                    displayScale = fit;
                    reRenderAllVisible();
                }
            });
        }

        // =============================================================
        // START
        // =============================================================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showGestureGate, { once: true });
        } else {
            showGestureGate();
        }

    })();
    </script>
</body>
</html>
